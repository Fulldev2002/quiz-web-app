<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Calm Science Explorer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js for 3D animation (Homepage) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        /* --- GLOBAL STYLES & COLOR PALETTE --- */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&family=Inter:wght@300;400;700&display=swap');

        :root {
            --color-bg-light: #f3f4f6;
            --color-primary-soft: #81A29D;
            --color-accent-calm: #B7C8C5;
            --color-text-dark: #333333;
            --color-bg-lab: #F0F5F2;
        }

        body {
            font-family: 'Nunito', 'Inter', sans-serif;
            background-color: var(--color-bg-light);
            color: var(--color-text-dark);
            min-height: 100vh;
        }

        /* --- HOMEPAGE ANIMATION STYLES --- */
        .calm-btn { transition: all 0.3s ease-in-out; }
        .calm-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(129, 162, 157, 0.4); }
        .calm-btn:active { transform: translateY(0); box-shadow: 0 4px 10px rgba(129, 162, 157, 0.5); }

        @keyframes subtle-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animated-bg {
            background: linear-gradient(-45deg, var(--color-bg-light), var(--color-accent-calm));
            background-size: 400% 400%;
            animation: subtle-shift 30s ease infinite;
        }

        #three-container {
            width: 100%; height: 150px; margin-bottom: 1rem;
            display: flex; justify-content: center; align-items: center;
            background-color: transparent; 
        }

        /* --- MOLECULE GARDEN STYLES --- */
        .atom-drag-source { cursor: grab; transition: transform 0.1s; }
        .atom-drag-source:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #current-molecule-container {
            border: 4px dashed #CCD6D4; min-height: 150px;
            display: flex; align-items: center; justify-content: center;
            flex-wrap: wrap; padding: 1rem; transition: background-color 0.3s;
        }
        #current-molecule-container:hover { background-color: #E8EDE9; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse { animation: pulse 1.5s infinite; }

        /* --- FORCES & MOTION STYLES --- */
        #simulator-canvas {
            border: 2px solid var(--color-primary-soft); background-color: white;
            border-radius: 1rem; width: 100%; aspect-ratio: 16 / 9;
            max-width: 800px; margin: 0 auto;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
        .object-block {
            transition: transform 3s ease-in;
            fill: #D9A891; stroke: #A8816D; stroke-width: 2;
        }
        .control-button { transition: all 0.2s ease-in-out; }
        .control-button:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transform: translateY(-1px); }

        /* --- ACCESSIBILITY & VIEW STYLES --- */
        .high-contrast { background-color: #000000 !important; color: #FFFFFF !important; }
        .high-contrast .animated-bg { background: #000000 !important; }
        .high-contrast .bg-white, .high-contrast .bg-white\/90, .high-contrast #message-box {
            background-color: #111111 !important; border: 2px solid #FFFF00 !important; color: #FFFFFF !important;
        }
        .high-contrast .text-gray-700, .high-contrast .text-gray-600, .high-contrast .text-gray-800 { color: #FFFFFF !important; }
        .high-contrast .calm-btn { background-color: #FFFF00 !important; color: #000000 !important; }
        .high-contrast .shadow-xl { box-shadow: none !important; }
        
        /* Only hide views that are NOT the homepage by default */
        .view.hidden {
            display: none !important;
        }

        .quiz-option {
            transition: background-color 0.15s;
            cursor: pointer;
        }
        .quiz-option:disabled {
            cursor: default;
        }
        
        /* New custom style for bold, emphasized terms in learning section */
        .concept-term {
            font-weight: 800; /* Extra bold */
            font-size: 1.1rem; /* Slightly larger text */
            color: var(--color-text-dark);
            margin-right: 0.25rem;
        }
        
        /* --- CUSTOM CSS DIAGRAMS --- */
        .diagram-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 150px;
            position: relative;
        }
        .atom {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .electron {
            width: 6px;
            height: 6px;
            background-color: #FF69B4; /* Pink for electrons */
            border-radius: 50%;
            position: absolute;
            box-shadow: 0 0 2px #FF69B4;
        }
        .electron-shell {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 1px solid #ccc;
            position: absolute;
        }
        .bond-arrow {
            position: absolute;
            width: 50px;
            height: 2px;
            background: #81A29D;
            transform: translateY(-50%);
            z-index: 10;
        }
        .bond-arrow::after {
            content: '‚ñ∂';
            position: absolute;
            right: -5px;
            top: -10px;
            color: #81A29D;
            font-size: 18px;
        }
    </style>
</head>
<body class="animated-bg p-4 md:p-8">

    <!-- Accessibility Toggle (Floating Orb) -->
    <div id="accessibility-toggle" class="fixed bottom-4 right-4 z-50">
        <button onclick="window.toggleAccessibility()" class="p-3 bg-white text-gray-700 shadow-xl rounded-full focus:outline-none ring-4 ring-white hover:bg-gray-100 transition duration-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.526.321 1.037.47 1.57.47.604 0 1.189-.148 1.71-.47z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>
        <div id="accessibility-menu" class="hidden absolute bottom-14 right-0 w-48 bg-white p-4 rounded-lg shadow-xl ring-1 ring-gray-200">
            <label class="flex items-center space-x-2 text-sm text-gray-700">
                <input type="checkbox" id="highContrast" class="rounded text-indigo-500" onchange="window.applyAccessibility()">
                <span>High Contrast</span>
            </label>
            <label class="flex items-center space-x-2 mt-2 text-sm text-gray-700">
                <input type="checkbox" id="dyslexicFont" class="rounded text-indigo-500" onchange="window.applyAccessibility()">
                <span>Dyslexia Font</span>
            </label>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="max-w-4xl mx-auto bg-white/90 backdrop-blur-sm p-6 md:p-10 rounded-xl shadow-2xl">
        
        <!-- Navigation Header (Always Visible) -->
        <nav class="mb-8 border-b pb-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">
                <button onclick="window.setView('home')" class="text-indigo-600 hover:text-indigo-800 transition">
                    Science Explorer
                </button>
            </h1>
            <div id="user-status" class="text-sm text-gray-400">
                Auth Status: Connecting...
            </div>
        </nav>

        <!-- --- VIEW: HOMEPAGE (Visible by default) --- -->
        <section id="view-home" class="view">
            <header class="text-center mb-12">
                <!-- Three.js 3D Animation Container -->
                <div id="three-container"></div>

                <h2 class="text-4xl md:text-5xl font-extrabold text-gray-800 leading-tight">Learn Without Overload.</h2>
            </header>

            <!-- Benefits Section -->
            <section class="mb-12 grid grid-cols-1 sm:grid-cols-3 gap-6 text-center">
                <div class="p-4 bg-white rounded-lg shadow-md border-t-4 border-emerald-400">
                    <p class="font-bold text-lg text-emerald-600">Muted Colors</p>
                    <p class="text-sm text-gray-500">Sensory-friendly design.</p>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-md border-t-4 border-indigo-400">
                    <p class="font-bold text-lg text-indigo-600">No Timers</p>
                    <p class="text-sm text-gray-500">Low-pressure environment.</p>
                </div>
                <div class="p-4 bg-white rounded-lg shadow-md border-t-4 border-pink-400">
                    <p class="font-bold text-lg text-pink-600">Deep Learning</p>
                    <p class="text-sm text-gray-500">Puzzle-based understanding.</p>
                </div>
            </section>

            <!-- Featured Sections -->
            <section class="mb-12">
                <h3 class="text-2xl font-bold mb-6 border-b pb-2 text-gray-700">Explore & Learn</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                    <!-- Card 1: Concepts Library (PRIORITIZED) -->
                    <div class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.02]">
                        <h4 class="text-xl font-semibold mb-2 text-gray-800">Concepts Library</h4>
                        <span class="inline-block px-3 py-1 text-xs font-medium text-orange-600 bg-orange-100 rounded-full mb-3">Basic Science</span>
                        <p class="text-gray-600 mb-4 text-sm">Read foundational science explanations and take fixed quizzes.</p>
                        <button onclick="window.setView('learn')" class="calm-btn w-full py-3 bg-orange-500 text-white font-bold rounded-lg shadow-md hover:bg-orange-600 transition duration-300 ease-in-out">
                            Explore Concepts
                        </button>
                    </div>
                    
                    <!-- Card 2: Molecule Garden (Accessible via Concepts) -->
                    <div class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.02]">
                        <h4 class="text-xl font-semibold mb-2 text-gray-800">Molecule Garden</h4>
                        <span class="inline-block px-3 py-1 text-xs font-medium text-purple-600 bg-purple-100 rounded-full mb-3">Chemistry Game</span>
                        <p class="text-gray-600 mb-4 text-sm">Grow molecules by combining atoms peacefully.</p>
                        <button id="btn-molecule-home" onclick="window.setView('molecule')" class="calm-btn w-full py-3 bg-[var(--color-primary-soft)] text-white font-bold rounded-lg shadow-md transition duration-300 ease-in-out">
                            Start Calm Lab
                        </button>
                    </div>

                    <!-- Card 3: Forces & Motion -->
                    <div class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.02]">
                        <h4 class="text-xl font-semibold mb-2 text-gray-800">Forces & Motion</h4>
                        <span class="inline-block px-3 py-1 text-xs font-medium text-blue-600 bg-blue-100 rounded-full mb-3">Physics Game</span>
                        <p class="text-gray-600 mb-4 text-sm">Experiment with gravity and incline using visual observation.</p>
                        <button onclick="window.setView('forces')" class="calm-btn w-full py-3 bg-[var(--color-primary-soft)] text-white font-bold rounded-lg shadow-md hover:bg-emerald-600 transition duration-300 ease-in-out">
                            Start Calm Lab
                        </button>
                    </div>
                </div>
            </section>
        </section>

        <!-- --- VIEW: LEARNING CONCEPTS --- (PRIORITIZED) -->
        <section id="view-learn" class="view hidden" style="background-color: var(--color-bg-lab);">
            <header class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-700">üìö Fundamental Concepts Library</h2>
                <p class="text-gray-500 mt-1">Concise, non-overwhelming explanations of key science ideas.</p>
            </header>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Concept 1: Ionic Bonding -->
                <div id="concept-ionic" class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-3 text-purple-600">1. Ionic Bonding: The Electron Transfer</h3>
                    <p class="text-gray-700 mb-4 text-sm">
                        Ionic bonding happens when atoms transfer valence electrons to achieve a stable, full outer shell. 
                    </p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 pl-4 mb-4">
                        <li><span class="concept-term">Metals</span> have low valence electron counts (typically 1, 2, or 3). They prefer to lose these electrons to become positively charged ions.</li>
                        <li><span class="concept-term">Nonmetals</span> have high valence electron counts (typically 5, 6, or 7). They prefer to gain electrons to become negatively charged ions.</li>
                        <li><span class="concept-term">Stability:</span> When an atom with 1-3 electrons combines with an atom with 5-7 electrons, the transfer of electrons makes both atoms stable.</li>
                    </ul>
                    
                    <!-- Diagram -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 text-center">
                        <p class="font-bold text-sm text-gray-700 mb-2">Example: Sodium Chloride (Na + Cl)</p>
                        
                        <!-- CUSTOM CSS DIAGRAM: IONIC BONDING (Na + Cl) -->
                        <div class="diagram-container">
                            <!-- Sodium (Na) Atom -->
                            <div class="atom bg-blue-100 text-blue-700 border border-blue-300">Na
                                <div class="electron" style="top: 10px; right: 10px;"></div>
                            </div>
                            
                            <span class="mx-3 text-2xl text-gray-600">+</span>
                            
                            <!-- Chlorine (Cl) Atom -->
                            <div class="atom bg-green-100 text-green-700 border border-green-300">Cl
                                <!-- 7 valence electrons -->
                                <div class="electron" style="top: 5px; left: 50%; transform: translateX(-50%);"></div>
                                <div class="electron" style="top: 15px; right: 5px;"></div>
                                <div class="electron" style="top: 30px; right: 5px;"></div>
                                <div class="electron" style="bottom: 15px; right: 5px;"></div>
                                <div class="electron" style="bottom: 5px; left: 50%; transform: translateX(-50%);"></div>
                                <div class="electron" style="bottom: 15px; left: 5px;"></div>
                                <div class="electron" style="top: 30px; left: 5px;"></div>
                            </div>
                            
                            <!-- Transfer Arrow -->
                            <div class="bond-arrow" style="left: 140px; top: 50px;"></div>

                            <span class="mx-3 text-2xl text-gray-600" style="left: 200px; position: absolute;">‚Üí</span>
                        </div>
                        
                        <p class="text-xs text-gray-500">Sodium (1 valence electron) gives its electron to Chlorine (7 valence electrons), creating strong attraction.</p>
                        <p class="font-semibold text-sm text-gray-700 mt-2">Equation: Na + Cl ===== NaCl</p>
                    </div>
                    
                    <!-- Fixed Quiz 1 -->
                    <div id="ionic-quiz-container" class="mt-6 border-t pt-4">
                        <h4 class="font-semibold mb-2 text-gray-700">Learning Check: Ionic Bonding</h4>
                        <div id="ionic-quiz-area" class="space-y-3">
                            <!-- Questions loaded by window.loadFixedQuiz('ionic') -->
                            <button id="btn-ionic-quiz-start" onclick="window.loadFixedQuiz('ionic')" class="calm-btn w-full py-2 bg-purple-500 text-white font-bold rounded-lg shadow-md hover:bg-purple-600 transition">
                                Start Quiz (3 Questions)
                            </button>
                        </div>
                        <div id="ionic-feedback" class="mt-3 font-bold text-center"></div>
                    </div>
                </div>

                <!-- Concept 2: Covalent Bonding -->
                <div id="concept-covalent" class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-3 text-emerald-600">2. Covalent Bonding: The Electron Share</h3>
                    <p class="text-gray-700 mb-4 text-sm">
                        Covalent bonding occurs when atoms share valence electrons to achieve a stable outer shell. This typically happens between two nonmetal atoms.
                    </p>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-600 pl-4 mb-4">
                        <li><span class="concept-term">Nonmetals</span> (like Hydrogen, Oxygen, Carbon) have high valence electron counts (typically 4-7).</li>
                        <li><span class="concept-term">Sharing:</span> Instead of giving or taking, they overlap their valence shells and share electrons, counting those shared electrons toward both atoms' octets.</li>
                        <li><span class="concept-term">Stability:</span> Examples: Water ($\text{H}_2\text{O}$) involves Oxygen sharing electrons with two Hydrogen atoms.</li>
                    </ul>
                    
                    <!-- Diagram -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 text-center">
                        <p class="font-bold text-sm text-gray-700 mb-2">Example: Water (H2O) Covalent Bonding</p>
                        
                        <!-- CUSTOM CSS DIAGRAM: COVALENT BONDING (H2O) -->
                        <div class="diagram-container">
                            <!-- Hydrogen 1 (H) -->
                            <div class="atom bg-red-100 text-red-700 border border-red-300" style="position: absolute; left: 50px; top: 60px; width: 40px; height: 40px;">H
                                <div class="electron" style="top: 10px; right: 10px;"></div>
                            </div>
                            
                            <!-- Oxygen (O) - Center -->
                            <div class="atom bg-purple-100 text-purple-700 border border-purple-300" style="position: absolute; left: 125px; top: 30px; width: 60px; height: 60px;">O
                                <!-- Shared pair 1 -->
                                <div class="electron" style="top: 20px; left: 5px;"></div>
                                <div class="electron" style="top: 20px; left: 15px;"></div>
                                
                                <!-- Shared pair 2 (for other H) -->
                                <div class="electron" style="top: 5px; right: 20px;"></div>
                                <div class="electron" style="top: 15px; right: 20px;"></div>
                                
                                <!-- Lone Pair -->
                                <div class="electron" style="bottom: 5px; left: 5px;"></div>
                                <div class="electron" style="bottom: 5px; left: 15px;"></div>
                            </div>
                            
                            <!-- Hydrogen 2 (H) -->
                            <div class="atom bg-red-100 text-red-700 border border-red-300" style="position: absolute; left: 210px; top: 60px; width: 40px; height: 40px;">H
                                <div class="electron" style="top: 10px; left: 10px;"></div>
                            </div>
                            
                            <span class="text-xs text-gray-500" style="position: absolute; left: 120px; top: 120px;">(Simplified V-Shape structure)</span>
                        </div>

                        <p class="text-xs text-gray-500">Oxygen (6 valence electrons) shares electrons with two Hydrogens (1 valence electron each) to achieve stability.</p>
                        <p class="font-semibold text-sm text-gray-700 mt-2">Equation: 2H + O ======= H20</p>
                    </div>

                    <!-- Fixed Quiz 2 -->
                    <div id="covalent-quiz-container" class="mt-6 border-t pt-4">
                        <h4 class="font-semibold mb-2 text-gray-700">Learning Check: Covalent Bonding</h4>
                        <div id="covalent-quiz-area" class="space-y-3">
                            <!-- Questions loaded by window.loadFixedQuiz('covalent') -->
                            <button id="btn-covalent-quiz-start" onclick="window.loadFixedQuiz('covalent')" class="calm-btn w-full py-2 bg-emerald-500 text-white font-bold rounded-lg shadow-md hover:bg-emerald-600 transition">
                                Start Quiz (3 Questions)
                            </button>
                        </div>
                        <div id="covalent-feedback" class="mt-3 font-bold text-center"></div>
                        <!-- Goal: Unlock Molecule Garden -->
                        <div id="covalent-unlock-message" class="mt-4 p-3 bg-yellow-100 rounded-lg text-center font-medium text-yellow-800 hidden">
                            Complete this quiz to unlock Molecule Garden!
                        </div>
                    </div>
                </div>
            </div>
            
        </section>

        <!-- --- VIEW: MOLECULE GARDEN --- -->
        <section id="view-molecule" class="view hidden" style="background-color: var(--color-bg-lab);">
            <header class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-700">üåø Molecule Garden Lab</h2>
                <p class="text-gray-500 mt-1">Combine atoms to discover stable molecules. Your discoveries are saved in the garden below.</p>
            </header>

            <!-- Atom Palette -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Atom Palette</h3>
                <div class="flex flex-wrap gap-4 justify-center">
                    <!-- Hydrogen -->
                    <div class="atom-drag-source p-3 rounded-xl bg-gray-50 shadow-md text-center" draggable="true" onclick="window.addAtom('H')" data-atom="H" ondragstart="window.handleDragStart(event, 'H')">
                        <span class="text-4xl text-gray-400">‚ö™</span>
                        <p class="font-medium text-sm mt-1 text-gray-700">H (Valency 1)</p>
                    </div>
                    <!-- Oxygen -->
                    <div class="atom-drag-source p-3 rounded-xl bg-red-50 shadow-md text-center" draggable="true" onclick="window.addAtom('O')" data-atom="O" ondragstart="window.handleDragStart(event, 'O')">
                        <span class="text-4xl text-red-500">üî¥</span>
                        <p class="font-medium text-sm mt-1 text-gray-700">O (Valency 2)</p>
                    </div>
                    <!-- Carbon -->
                    <div class="atom-drag-source p-3 rounded-xl bg-green-50 shadow-md text-center" draggable="true" onclick="window.addAtom('C')" data-atom="C" ondragstart="window.handleDragStart(event, 'C')">
                        <span class="text-4xl text-green-500">üü¢</span>
                        <p class="font-medium text-sm mt-1 text-gray-700">C (Valency 4)</p>
                    </div>
                    <!-- Nitrogen -->
                    <div class="atom-drag-source p-3 rounded-xl bg-blue-50 shadow-md text-center" draggable="true" onclick="window.addAtom('N')" data-atom="N" ondragstart="window.handleDragStart(event, 'N')">
                        <span class="text-4xl text-blue-500">üîµ</span>
                        <p class="font-medium text-sm mt-1 text-gray-700">N (Valency 3)</p>
                    </div>
                </div>
            </div>

            <!-- Molecular Assembly Area -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Assembly Area</h3>
                
                <div id="current-molecule-container" class="rounded-xl mb-4">
                    <div id="current-molecule" class="min-h-[100px] flex items-center justify-center gap-4">
                        <p class="text-gray-400">Drag or click atoms here to start a new molecule.</p>
                    </div>
                </div>

                <p id="valency-status" class="text-center text-sm font-medium text-gray-600 mb-4">Total Valency: 0 (Must be even and balanced)</p>
                <p id="result-text" class="text-center h-8"></p>

                <div class="text-center mt-4">
                    <button onclick="window.resetMolecule()" class="px-6 py-2 bg-red-400 text-white font-bold rounded-lg shadow-md hover:bg-red-500 transition duration-300">
                        Reset Molecule
                    </button>
                </div>
            </div>

            <!-- Discovered Garden -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Your Molecular Garden (Saved)</h3>
                <div id="molecule-garden-ui" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <p class="text-gray-500 italic">Loading discoveries...</p>
                </div>
                <p class="text-xs text-gray-400 mt-4">Your garden is saved and accessible across devices.</p>
            </div>
        </section>
        
        <!-- --- VIEW: FORCES & MOTION --- -->
        <section id="view-forces" class="view hidden" style="background-color: var(--color-bg-lab);">
            <header class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-700">üî¨ Forces & Motion: Puzzle Lab</h2>
                <p class="text-gray-500 mt-1">Drag the **red handle** to change the ramp's angle (Max 23.2¬∞). The gray block will slide from the top.</p>
            </header>

            <!-- Simulation Controls -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Ramp Angle: <span id="angle-value">0.0</span>¬∞</h3>
                
                <div class="text-center">
                    <button onclick="window.runSimulation()" class="control-button px-8 py-3 bg-[var(--color-primary-soft)] text-white font-bold rounded-lg shadow-md hover:bg-emerald-600 transition duration-300">
                        ‚ñ∂Ô∏è OBSERVE MOTION
                    </button>
                </div>
            </div>

            <!-- Simulation Canvas (SVG) -->
            <div id="simulator-container" class="text-center">
                <svg id="simulator-canvas" viewBox="0 0 800 450" preserveAspectRatio="xMidYMid meet">
                    <!-- Base Line -->
                    <line x1="50" y1="400" x2="750" y2="400" stroke="#333" stroke-width="2" />
                    
                    <!-- The Inclined Plane (Ramp) -->
                    <polygon id="ramp" points="50,400 750,200 750,400" fill="#CCD6D4" stroke="var(--color-primary-soft)" stroke-width="3" />
                    
                    <!-- The Moving Object (Block) -->
                    <rect id="moving-block" x="50" y="370" width="30" height="30" rx="4" class="object-block" transform="translate(0, 0) rotate(0, 65, 385)" />
                    
                    <!-- Draggable Handle (Apex - Left side) -->
                    <circle id="ramp-handle" cx="50" cy="400" r="15" fill="#EF4444" stroke="#D9A891" stroke-width="3" style="cursor: grab;" 
                            onmousedown="window.handleRampDragStart(event)" ontouchstart="window.handleRampDragStart(event)" />

                    <!-- Text Feedback -->
                    <text id="forces-result-text" x="400" y="50" text-anchor="middle" font-size="24" fill="#333" font-weight="bold" opacity="0"></text>
                </svg>
            </div>

            <!-- Instructions/Challenge -->
            <div class="mt-8 p-6 bg-white rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">The Challenge</h3>
                <p class="text-gray-600 mb-2">Adjust the angle and observe how speed and time are affected by the force of gravity.</p>
            </div>
        </section>
        
    </div>

    <!-- Modal Placeholder -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
        <div id="message-box" class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-gray-700 font-medium mb-4">Message content.</p>
            <button onclick="window.hideModal()" class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">Close</button>
        </div>
    </div>

    <!-- Main JavaScript Code -->
    <script type="module">
        // --- Firebase Modular Imports (The correct way to load v11) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL APP STATE & UTILITIES ---
        let currentView = 'home';
        let db, auth, userId;
        let gardenListenerSetup = false;
        let quizState = { active: false, currentQuizType: null, questions: [], score: 0, currentQuestionIndex: 0 };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        setLogLevel('Debug'); // Enable Firebase debug logging
        
        // --- FIXED QUIZ DATA (REPLACING AI GENERATION) ---
        const FIXED_QUIZZES = {
            ionic: [
                {
                    question: "What is the typical range of valence electrons for a Metal atom, such as Sodium?",
                    options: ["4 to 7", "0 or 8", "1 to 3", "2 to 4"],
                    correctAnswer: "1 to 3"
                },
                {
                    question: "Ionic bonds are formed when atoms...",
                    options: ["Share valence electrons.", "Are both nonmetals.", "Transfer valence electrons.", "Are both noble gases."],
                    correctAnswer: "Transfer valence electrons."
                },
                {
                    question: "When a metal loses an electron, it becomes a...",
                    options: ["Negative ion (anion)", "Neutral atom", "Covalent bond", "Positive ion (cation)"],
                    correctAnswer: "Positive ion (cation)"
                }
            ],
            covalent: [
                {
                    question: "Covalent bonds primarily form between which types of atoms?",
                    options: ["A metal and a nonmetal", "Two metals", "Two nonmetals", "Noble gases"],
                    correctAnswer: "Two nonmetals"
                },
                {
                    question: "How do atoms achieve stability in a covalent bond, like in water (H‚ÇÇO)?",
                    options: ["By gaining electrons", "By sharing valence electrons", "By transferring electrons completely", "By becoming positive ions"],
                    correctAnswer: "By sharing valence electrons"
                },
                {
                    question: "In the molecule Water (H‚ÇÇO), how many valence electrons does Oxygen share in total?",
                    options: ["Zero", "Four", "One", "Two"],
                    correctAnswer: "Two" // Shares one with each H
                }
            ]
        };

        
        // --- FIREBASE/FIRESTORE LOGIC ---
        
        async function initializeFirebase() {
            if (!firebaseConfig) {
                document.getElementById('user-status').textContent = 'Auth Failed (No Config)';
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                document.getElementById('user-status').textContent = 'Auth Failed';
                // Fallback: Use a unique ID if auth fails
                userId = crypto.randomUUID(); 
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-status').textContent = `User ID: ${userId.substring(0, 8)}...`;
                    exposedUpdateMoleculeGardenButton();
                } else {
                    document.getElementById('user-status').textContent = 'Signed Out';
                }
            });
        }
        
        // --- MOLECULE GARDEN ACCESS CONTROL ---
        const MOLECULE_GARDEN_UNLOCKED = "moleculeGardenUnlocked";
        
        function updateMoleculeGardenButton() {
            const isUnlocked = localStorage.getItem(MOLECULE_GARDEN_UNLOCKED) === 'true';
            const btnHome = document.getElementById('btn-molecule-home');
            
            if (btnHome) {
                btnHome.disabled = !isUnlocked;
                btnHome.textContent = isUnlocked ? 'Start Calm Lab' : 'LOCKED (Complete Quiz)';
                btnHome.classList.toggle('bg-gray-400', !isUnlocked);
                btnHome.classList.toggle('hover:bg-gray-500', !isUnlocked);
                btnHome.classList.toggle('bg-[var(--color-primary-soft)]', isUnlocked);
            }
        }
        const exposedUpdateMoleculeGardenButton = updateMoleculeGardenButton;
        
        // --- NAVIGATION & VIEW MANAGEMENT ---
        function setView(viewName) {
            currentView = viewName;
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.classList.add('hidden'));
            
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) {
                targetView.classList.remove('hidden');
            }

            // Manage 3D animation visibility
            if (viewName === 'home') {
                if (typeof initThree === 'function' && typeof animate === 'function') {
                    if (!window.animationFrameId) {
                        initThree();
                        animate();
                    }
                }
            } else {
                if (window.animationFrameId) {
                    cancelAnimationFrame(window.animationFrameId);
                    window.animationFrameId = null;
                }
            }

            // Start Molecule Garden listener if navigating to it
            if (viewName === 'molecule' && !gardenListenerSetup && userId) {
                window.setupRealtimeGardenListener();
            }
            
            // Re-initialize Forces & Motion if navigating to it
            if (viewName === 'forces') {
                window.setupForcesListeners(); 
            }
        }

        // --- 3D ANIMATION (THREE.JS) - HOMEPAGE ---
        let scene, camera, renderer, molecule;
        const threeContainer = document.getElementById('three-container');
        window.animationFrameId = null;

        function initThree() {
            // Check if renderer exists (prevent multiple initializations)
            if (renderer) return;

            scene = new THREE.Scene();
            
            // Set size based on container for responsiveness
            const width = threeContainer.clientWidth;
            const height = 150; 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            threeContainer.appendChild(renderer.domElement);

            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.z = 5;

            const ambientLight = new THREE.AmbientLight(0xdddddd, 1.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5); 
            directionalLight.position.set(0, 1, 1);
            scene.add(directionalLight);

            molecule = new THREE.Group();
            scene.add(molecule);

            const mat1 = new THREE.MeshPhongMaterial({ color: 0x81A29D, shininess: 30 }); // Soft Blue-Green
            const mat2 = new THREE.MeshPhongMaterial({ color: 0xB7C8C5, shininess: 30 }); // Lighter Accent

            const atom1 = new THREE.Mesh(new THREE.SphereGeometry(0.5, 32, 32), mat1);
            const atom2 = new THREE.Mesh(new THREE.SphereGeometry(0.3, 32, 32), mat2);
            const atom3 = new THREE.Mesh(new THREE.SphereGeometry(0.3, 32, 32), mat2);

            atom1.position.set(0, 0, 0);
            atom2.position.set(1.5, 0.5, 0);
            atom3.position.set(-1.5, -0.5, 0);

            function createBond(start, end) {
                const distance = start.position.distanceTo(end.position);
                const geometry = new THREE.CylinderGeometry(0.1, 0.1, distance, 8);
                const material = new THREE.MeshPhongMaterial({ color: 0x666666, shininess: 10 });
                const bond = new THREE.Mesh(geometry, material);
                
                bond.position.set( (start.position.x + end.position.x) / 2, (start.position.y + end.position.y) / 2, (start.position.z + end.position.z) / 2 );
                bond.lookAt(start.position);
                bond.rotation.x += Math.PI / 2;
                return bond;
            }

            const bond1 = createBond(atom1, atom2);
            const bond2 = createBond(atom1, atom3);
            
            molecule.add(atom1, atom2, atom3, bond1, bond2);

            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            if (threeContainer.clientWidth > 0) {
                const width = threeContainer.clientWidth;
                const height = 150;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
        }

        function animate() {
            window.animationFrameId = requestAnimationFrame(animate);

            if (molecule) {
                molecule.rotation.x += 0.001;
                molecule.rotation.y += 0.002;
            }
            
            if (renderer) {
                renderer.render(scene, camera);
            }
        }

        // --- MODAL UTILITIES ---
        function showModal(message) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modal-container').classList.add('hidden');
        }

        // --- ACCESSBILITY UTILITIES ---
        function toggleAccessibility() {
            document.getElementById('accessibility-menu').classList.toggle('hidden');
        }

        function applyAccessibility() {
            const body = document.body;
            const highContrastCheckbox = document.getElementById('highContrast');
            const dyslexicFontCheckbox = document.getElementById('dyslexicFont');

            if (highContrastCheckbox.checked) {
                body.classList.add('high-contrast');
            } else {
                body.classList.remove('high-contrast');
            }

            if (dyslexicFontCheckbox.checked) {
                body.style.fontFamily = "Verdana, Arial, sans-serif"; 
                body.classList.add('dyslexia-font');
            } else {
                body.style.fontFamily = "'Nunito', 'Inter', sans-serif";
                body.classList.remove('dyslexia-font');
            }
        }

        // --- INITIALIZATION ---
        // Expose functions globally for HTML attributes (FIX 2)
        window.setView = setView;
        window.toggleAccessibility = toggleAccessibility;
        window.applyAccessibility = applyAccessibility;
        window.showModal = showModal;
        window.hideModal = hideModal;
        
        // This is the core application setup function called after module load
        function setupApp() {
            initializeFirebase();
            
            // Manually show only the first view and hide the rest
            const views = document.querySelectorAll('.view');
            views.forEach(view => {
                if (view.id !== 'view-home') {
                    view.classList.add('hidden');
                }
            });

            // Init Three.js and start animation loop
            initThree(); // Calling local function
            animate(); // Calling local function
            
            // Setup listeners for Molecule Garden
            setupMoleculeListeners();
            
            // Initial setup for Forces & Motion 
            setupForcesListeners();

            // Set initial state for Molecule Garden lock
            exposedUpdateMoleculeGardenButton();
        }


        // --- MOLECULE GARDEN LOGIC ---

        // Firestore Persistence
        function getMoleculeGardenDocRef(uid) {
            return doc(db, 
                'artifacts', appId, 
                'public', 'data', 
                'molecule_gardens', uid);
        }

        async function saveMoleculeGarden(gardenState) {
            if (!db || !userId) {
                console.warn("Database not ready or User not signed in. Cannot save.");
                return;
            }
            try {
                await setDoc(getMoleculeGardenDocRef(userId), {
                    molecules: gardenState,
                    lastUpdated: serverTimestamp(),
                    userId: userId,
                    visibility: 'public' 
                }, { merge: true });
                console.log("Garden saved successfully.");
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        window.setupRealtimeGardenListener = function() {
            if (!db || !userId || gardenListenerSetup) return;

            const unsub = onSnapshot(getMoleculeGardenDocRef(userId), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const molecules = data.molecules || [];
                    updateGardenUI(molecules);
                } else {
                    console.log("No existing garden data found, starting fresh.");
                    updateGardenUI([]);
                }
            }, (error) => {
                console.error("Error listening to garden data:", error);
                showModal("Error reading your saved progress.");
            });
            gardenListenerSetup = true; // Flag to prevent multiple listeners
            console.log("Molecule Garden listener started.");
        }

        // Game Data
        const atoms = {
            H: { name: 'Hydrogen', valency: 1, color: 'text-gray-400', emoji: '‚ö™' },
            O: { name: 'Oxygen', valency: 2, color: 'text-red-500', emoji: 'üî¥' },
            C: { name: 'Carbon', valency: 4, color: 'text-green-500', emoji: 'üü¢' },
            N: { name: 'Nitrogen', valency: 3, color: 'text-blue-500', emoji: 'üîµ' }
        };

        const recipes = [
            { name: "Water (H‚ÇÇO)", atoms: { H: 2, O: 1 }, result: 'üåä' },
            { name: "Carbon Dioxide (CO‚ÇÇ)", atoms: { C: 1, O: 2 }, result: 'üí®' },
            { name: "Methane (CH‚ÇÑ)", atoms: { C: 1, H: 4 }, result: 'üî•' }
        ];

        let currentMolecule = {};
        let discoveredMolecules = [];
        
        // Simple Audio Generator (Click sound)
        function playClickSound() {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(context.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, context.currentTime); // A4
            gainNode.gain.setValueAtTime(0.1, context.currentTime);

            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.0001, context.currentTime + 0.1);
            oscillator.stop(context.currentTime + 0.1);
        }

        function addAtom(symbol) {
            currentMolecule[symbol] = (currentMolecule[symbol] || 0) + 1;
            updateCurrentMoleculeUI();
        }

        function resetMolecule() {
            currentMolecule = {};
            document.getElementById('current-molecule').innerHTML = '<p class="text-gray-400">Drag or click atoms here to start a new molecule.</p>';
            document.getElementById('valency-status').textContent = 'Total Valency: 0 (Must be even and balanced)';
            document.getElementById('result-text').textContent = '';
        }

        function updateCurrentMoleculeUI() {
            const container = document.getElementById('current-molecule');
            container.innerHTML = '';
            let valencyUsed = 0;

            for (const atomSymbol in currentMolecule) {
                const count = currentMolecule[atomSymbol];
                const atomInfo = atoms[atomSymbol];
                valencyUsed += atomInfo.valency * count;

                const atomElement = document.createElement('div');
                atomElement.className = `${atomInfo.color} text-4xl font-bold inline-block p-2`;
                atomElement.textContent = `${atomInfo.emoji} x${count}`;
                container.appendChild(atomElement);
            }

            document.getElementById('valency-status').textContent = `Total Valency: ${valencyUsed} (Must be even and balanced)`;
            checkMolecule();
        }

        function checkMolecule() {
            const valencyTotal = Object.entries(currentMolecule).reduce((sum, [symbol, count]) => 
                sum + atoms[symbol].valency * count, 0);

            if (valencyTotal === 0) {
                document.getElementById('result-text').textContent = '';
                return;
            }

            if (valencyTotal % 2 !== 0) {
                document.getElementById('result-text').textContent = 'Valency is unbalanced. Keep building...';
                document.getElementById('result-text').className = 'text-red-500 font-medium';
                return;
            }

            for (const recipe of recipes) {
                let matches = true;
                const recipeAtoms = recipe.atoms;
                
                // Check if atom counts match exactly
                for (const symbol in recipeAtoms) {
                    if (currentMolecule[symbol] !== recipeAtoms[symbol]) {
                        matches = false; break;
                    }
                }
                for (const symbol in currentMolecule) {
                    if (currentMolecule[symbol] !== recipeAtoms[symbol]) {
                        matches = false; break;
                    }
                }

                if (matches) {
                    handleDiscovery(recipe);
                    return;
                }
            }

            document.getElementById('result-text').textContent = 'Stable, but not a known molecule. Try tweaking the ratio.';
            document.getElementById('result-text').className = 'text-yellow-600 font-medium';
        }

        function handleDiscovery(recipe) {
            if (!discoveredMolecules.some(m => m.name === recipe.name)) {
                discoveredMolecules.push(recipe);
                document.getElementById('result-text').textContent = `${recipe.result} Success! You discovered ${recipe.name}! ${recipe.result}`;
                document.getElementById('result-text').className = 'text-emerald-600 font-bold text-xl animate-pulse';
                saveMoleculeGarden(discoveredMolecules);
            } else {
                document.getElementById('result-text').textContent = `${recipe.name} already in your garden. Reset to try another!`;
                document.getElementById('result-text').className = 'text-gray-600 font-medium';
            }
        }

        function updateGardenUI(molecules) {
            discoveredMolecules = molecules;
            const garden = document.getElementById('molecule-garden-ui');
            garden.innerHTML = '';
            
            if (molecules.length === 0) {
                garden.innerHTML = '<p class="text-gray-500 italic">Your molecular garden is empty. Start bonding atoms!</p>';
            } else {
                molecules.forEach(mol => {
                    const card = document.createElement('div');
                    card.className = 'p-3 bg-white border border-gray-100 rounded-lg shadow-sm';
                    card.innerHTML = `<span class="text-3xl">${mol.result}</span> <span class="font-semibold text-gray-700">${mol.name}</span>`;
                    garden.appendChild(card);
                });
            }
        }

        // Drag and Drop Logic
        function handleDrop(event) {
            event.preventDefault();
            const symbol = event.dataTransfer.getData("atom-symbol");
            if (symbol) {
                addAtom(symbol);
            }
        }

        function exposedHandleDragStart(event, symbol) {
            event.dataTransfer.setData("atom-symbol", symbol);
        }

        function setupMoleculeListeners() {
            const dropTarget = document.getElementById('current-molecule-container');
            if (dropTarget) {
                dropTarget.addEventListener('dragover', (e) => e.preventDefault());
                dropTarget.addEventListener('drop', handleDrop);
            }
        }

        // --- FORCES & MOTION LOGIC (DRAG-BASED RAMP) ---

        const simulatorCanvas = document.getElementById('simulator-canvas');
        const ramp = document.getElementById('ramp');
        const block = document.getElementById('moving-block');
        const angleValueDisplay = document.getElementById('angle-value');
        const resultText = document.getElementById('forces-result-text');
        const rampHandle = document.getElementById('ramp-handle');

        // Simulation constants
        const SVG_WIDTH = 800;
        const SVG_HEIGHT = 450;
        const START_X = 50; // Apex/Handle X coordinate
        const END_X = 750; // Base X coordinate
        const BASE_Y = 400; // Base Y coordinate
        const MAX_HEIGHT_Y = 250; // Highest Y coordinate the handle can go (Approx 23.2 deg)
        const BLOCK_WIDTH = 30;

        let isHandleDragging = false;
        let currentAngle = 0; 
        
        // Helper to convert screen coordinates to SVG coordinates
        function getSvgCoords(clientX, clientY) {
            const rect = simulatorCanvas.getBoundingClientRect();
            const x = (clientX - rect.left) / rect.width * SVG_WIDTH;
            const y = (clientY - rect.top) / rect.height * SVG_HEIGHT;
            return { x, y };
        }

        // Updates ramp geometry, angle display, and block reset position
        function updateRampGeometry(newY) {
            // Clamp the new Y position to ensure it stays within bounds
            const clampedY = Math.min(Math.max(newY, MAX_HEIGHT_Y), BASE_Y);

            // Update the handle position
            rampHandle.setAttribute('cy', clampedY);
            
            // Points: (START_X, clampedY), (END_X, BASE_Y), (START_X, BASE_Y)
            ramp.setAttribute('points', `${START_X},${clampedY} ${END_X},${BASE_Y} ${START_X},${BASE_Y}`);

            // Calculate the angle based on the new height
            const height = BASE_Y - clampedY;
            const length = END_X - START_X; 
            
            // Angle = atan(Height / Base Length)
            const angleRad = Math.atan(height / length);
            currentAngle = angleRad * (180 / Math.PI);

            // Update UI
            angleValueDisplay.textContent = currentAngle.toFixed(1);
            resultText.style.opacity = 0;
            
            // Reset block to the apex of the ramp
            positionBlockOnRamp(clampedY);
        }
        
        // Function to apply block position and rotation at the apex
        function positionBlockOnRamp(clampedY) {
            // Block position starts at START_X (50) and clampedY - BLOCK_WIDTH
            const blockX = START_X;
            const blockY = clampedY - BLOCK_WIDTH;

            // Rotation center is the bottom-right corner of the block for the slide animation
            const blockCenterX = blockX + BLOCK_WIDTH;
            const blockCenterY = clampedY; 

            // Rotate the block to match the ramp angle
            const targetTransform = `translate(0 0) rotate(-${currentAngle}, ${blockCenterX}, ${blockCenterY})`;
            
            // Reset transition for snap-to-position
            block.style.transition = 'none';
            block.setAttribute('x', blockX);
            block.setAttribute('y', blockY);
            block.setAttribute('transform', targetTransform);

            // Re-enable smooth transition after a small delay
            setTimeout(() => {
                block.style.transition = 'transform 3s ease-in-out';
            }, 50);
        }

        function handleRampDragStart(event) {
            if (event.target.id === 'ramp-handle') {
                isHandleDragging = true;
                rampHandle.style.cursor = 'grabbing';
                if (event.type.startsWith('touch')) {
                    event.preventDefault();
                }
            }
        }

        function handleDragMove(event) {
            if (isHandleDragging) {
                const clientY = event.clientY || (event.touches ? event.touches[0].clientY : null);
                if (clientY === null) return;
                const svgCoords = getSvgCoords(0, clientY); 
                updateRampGeometry(svgCoords.y);
            }
        }

        function handleDragEnd() {
            if (isHandleDragging) {
                isHandleDragging = false;
                rampHandle.style.cursor = 'grab';
            }
        }

        // Attach global listeners for movement and release
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd); 
        document.addEventListener('touchmove', handleDragMove);
        document.addEventListener('touchend', handleDragEnd); 

        function runSimulation() {
            if (currentAngle < 1) {
                 showModal("The ramp is too flat (less than 1¬∞). The block won't move much!");
                 return;
            }
            playClickSound();

            // 1. Calculate the distance along the ramp (hypotenuse)
            const height = BASE_Y - parseFloat(rampHandle.getAttribute('cy'));
            const base = END_X - START_X;
            const hypotenuse = Math.sqrt(height * height + base * base);

            // 2. Calculate final block position on the ground (END_X)
            const finalX = END_X - BLOCK_WIDTH;
            const finalY = BASE_Y - BLOCK_WIDTH;

            // 3. The simulation duration (clamped)
            const angleRad = currentAngle * (Math.PI / 180);
            const accelerationFactor = Math.sin(angleRad);
            const duration = 5 / (accelerationFactor * 0.5 + 0.5); // Fixed distance, variable speed
            const clampedDuration = Math.min(Math.max(duration, 0.5), 5); // 0.5s to 5s

            // 4. Apply the final transform: Translate along the hypotenuse vector
            // We calculate the required shift from the starting X, Y to the final X, Y
            const startX = parseFloat(block.getAttribute('x'));
            const startY = parseFloat(block.getAttribute('y'));
            
            const dx = finalX - startX;
            const dy = finalY - startY;

            // The translation applied needs to move the block from (startX, startY) to (finalX, finalY)
            // It must also reset the rotation to 0 to make it look like it lands flat
            const finalTransform = `translate(${dx} ${dy}) rotate(0, ${finalX + 15}, ${finalY + 15})`;
            
            block.style.transitionDuration = `${clampedDuration.toFixed(2)}s`;
            block.style.transitionTimingFunction = 'ease-in'; // Simulate gravity
            block.setAttribute('transform', finalTransform);

            // 5. Display Feedback
            resultText.style.opacity = 0;
            setTimeout(() => {
                let message;
                let color;
                if (currentAngle < 7) {
                    message = `Low Angle (${currentAngle.toFixed(1)}¬∞): Slow slide. Duration: ${clampedDuration.toFixed(1)}s.`;
                    color = "#F59E0B";
                } else if (currentAngle < 18) {
                    message = `Moderate Angle (${currentAngle.toFixed(1)}¬∞): Clear acceleration. Duration: ${clampedDuration.toFixed(1)}s.`;
                    color = "#10B981";
                } else {
                    message = `High Angle (${currentAngle.toFixed(1)}¬∞): Fastest slide. Duration: ${clampedDuration.toFixed(1)}s.`;
                    color = "#EF4444";
                }

                resultText.textContent = message;
                resultText.setAttribute('fill', color);
                resultText.style.opacity = 1;
                block.style.transitionTimingFunction = 'ease-in-out'; // Reset timing function for future use
            }, clampedDuration * 1000); 

            // 6. Reset the simulation after a pause
            setTimeout(() => {
                block.style.transition = 'none';
                updateRampGeometry(parseFloat(rampHandle.getAttribute('cy')));
            }, clampedDuration * 1000 + 3000); 
        }

        // --- Initializer for Forces section ---
        function setupForcesListeners() { 
            // Initial ramp setup to MAX height (approx 23.2 degrees)
            updateRampGeometry(MAX_HEIGHT_Y);
        }

        // --- FIXED QUIZ LOGIC (REPLACING AI GENERATION) ---
        
        let quizRunning = false;
        
        function loadFixedQuiz(quizType) {
            if (quizRunning) return;
            
            quizState.active = true;
            quizState.currentQuizType = quizType;
            quizState.questions = FIXED_QUIZZES[quizType];
            quizState.score = 0;
            quizState.currentQuestionIndex = 0;
            quizRunning = true;

            const targetButton = document.getElementById(`btn-${quizType}-quiz-start`);
            if (targetButton) {
                 targetButton.style.display = 'none';
            }
            
            startQuiz();
        }

        function startQuiz() {
            const quizAreaId = `${quizState.currentQuizType}-quiz-area`;
            document.getElementById(quizAreaId).innerHTML = '';
            showNextQuestion();
        }

        function showNextQuestion() {
            const questionIndex = quizState.currentQuestionIndex;
            const questionData = quizState.questions[questionIndex];
            const quizAreaId = `${quizState.currentQuizType}-quiz-area`;
            const targetArea = document.getElementById(quizAreaId);
            
            if (!questionData) {
                return endQuiz();
            }

            // Shuffle options for better quiz experience
            const shuffledOptions = questionData.options.sort(() => Math.random() - 0.5);

            let html = `<h5 class="text-md font-bold mb-3">Question ${questionIndex + 1}/${quizState.questions.length}:</h5>`;
            html += `<p class="mb-4 text-gray-700">${questionData.question}</p>`;
            html += `<div class="space-y-2">`;
            
            shuffledOptions.forEach((option, index) => {
                // Ensure options are properly escaped for use in data-attribute and function call
                const cleanOption = option.replace(/'/g, "\\'");
                html += `<button onclick="checkAnswer('${cleanOption}')" 
                                class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-indigo-50 transition duration-150 text-gray-700 bg-white shadow-sm quiz-option"
                                data-option="${cleanOption}">
                            ${option}
                        </button>`;
            });

            html += `</div>`;
            targetArea.innerHTML = html;
        }

        function checkAnswer(selectedOption) {
            if (!quizState.active) return;
            
            const questionData = quizState.questions[quizState.currentQuestionIndex];
            const isCorrect = selectedOption === questionData.correctAnswer;
            const optionButtons = document.querySelectorAll(`#${quizState.currentQuizType}-quiz-area .quiz-option`);
            const feedbackElement = document.getElementById(`${quizState.currentQuizType}-feedback`);
            
            // Find the correct option and the selected option by their data-option attribute
            optionButtons.forEach(btn => {
                btn.disabled = true;
                const btnOption = btn.getAttribute('data-option');
                if (btnOption === questionData.correctAnswer) {
                    btn.classList.add('bg-emerald-200', 'font-bold');
                } else if (btnOption === selectedOption) {
                    btn.classList.add('bg-red-200', 'line-through');
                }
            });

            if (isCorrect) {
                quizState.score++;
                feedbackElement.textContent = `Correct! (${quizState.score}/${quizState.currentQuestionIndex + 1})`;
                feedbackElement.classList.remove('text-red-500');
                feedbackElement.classList.add('text-emerald-600');
            } else {
                feedbackElement.textContent = `Incorrect. The correct answer is: ${questionData.correctAnswer}`;
                feedbackElement.classList.remove('text-emerald-600');
                feedbackElement.classList.add('text-red-500');
            }

            // Move to next question after a brief delay
            setTimeout(() => {
                quizState.currentQuestionIndex++;
                showNextQuestion();
            }, 1500);
        }

        function endQuiz() {
            const quizType = quizState.currentQuizType;
            const targetArea = document.getElementById(`${quizType}-quiz-area`);
            const targetButtonStart = document.getElementById(`btn-${quizType}-quiz-start`);
            const feedbackElement = document.getElementById(`${quizType}-feedback`);
            
            const score = quizState.score;
            const total = quizState.questions.length;
            const scorePercentage = (score / total) * 100;

            if (targetButtonStart) {
                targetButtonStart.textContent = 'Start New Quiz';
                targetButtonStart.style.display = 'block'; // Show button again
            }
            quizRunning = false;
            quizState.active = false;
            
            if (targetArea) {
                targetArea.innerHTML = `<h5 class="text-xl font-bold text-center mb-3">Quiz Complete!</h5>
                                        <p class="text-center text-2xl font-extrabold text-indigo-600">${score}/${total}</p>
                                        <p class="text-center text-sm text-gray-600">Score: ${scorePercentage.toFixed(0)}%</p>`;
            }
            
            if (feedbackElement) {
                feedbackElement.textContent = ''; // Clear temporary feedback
            }

            // --- UNLOCK LOGIC ---
            if (quizType === 'covalent' && scorePercentage >= 66) { // Unlock on 2/3 correct
                localStorage.setItem(MOLECULE_GARDEN_UNLOCKED, 'true');
                showModal("Success! You've mastered Covalent Bonding. Molecule Garden is now unlocked on the homepage!");
                exposedUpdateMoleculeGardenButton();
                document.getElementById('covalent-unlock-message').classList.add('hidden');
            } else if (quizType === 'covalent') {
                const unlockMessage = document.getElementById('covalent-unlock-message');
                if (unlockMessage) {
                    unlockMessage.classList.remove('hidden');
                    unlockMessage.textContent = 'Score at least 66% to unlock Molecule Garden!';
                }
            }
        }


        // --- GLOBAL EXPOSURE (Ensure inline HTML calls work) ---
        // Functions called directly in HTML need to be defined here or exposed.
        window.setView = setView;
        window.toggleAccessibility = toggleAccessibility;
        window.applyAccessibility = applyAccessibility;
        window.showModal = showModal;
        window.hideModal = hideModal;
        window.initThree = initThree;
        window.animate = animate;
        window.addAtom = addAtom;
        window.resetMolecule = resetMolecule;
        window.checkAnswer = checkAnswer;
        window.loadFixedQuiz = loadFixedQuiz;
        window.startQuiz = startQuiz;
        window.runSimulation = runSimulation;
        window.handleRampDragStart = handleRampDragStart;
        
        
        // Final, most robust initializer
        window.onload = function() {
            setupApp();
        };

    </script>
</body>
</html>